\chapter{Codifica}

Questo capitolo tratta gli aspetti più interessanti della codifica dell'applicazione moviORDER. In particolare, il capitolo è stato diviso in sezioni che trattano la codifica di:
\begin{enumerate}
	\item \textbf{servizio web};
	\item \textbf{logica applicativa};
	\item \textbf{interfaccia grafica}.
\end{enumerate}

\section{Servizio web}

Per lo sviluppo del servizio web che permette all'applicazione di accedere al database presente sul server cloud di \visione{} si è utilizzato il linguaggio Java e, nello specifico, gli oggetti servlet. Per permettere agli oggetti servlet di interagire con il database si sono dovuti utilizzare i driver JDBC per Microsoft SQL Server, poiché moviORDER utilizza tale DBMS. 

\subsection{Servlet}

\subsubsection{Struttura di un oggetto servlet}

Un oggetto servlet è una classe Java che eredita dalla classe \textit{HttpServlet}, appartenente al package \textit{javax.servlet.http}. \textit{HttpServlet} è una classe astratta che può essere estesa per creare un servlet HTTP utilizzabile per un sito web. Nel progetto realizzato, il servlet è stato utilizzato per acquisire richieste HTTP POST, elaborarle interrogando il database sul server cloud di \visione{}, e per rispondere ad esse tramite una stringa in formato JSON. Il metodo di \textit{HttpServlet} che è stato implementato da ogni servlet concreto è:
\begin{enumerate}
	\item \textit{protected void doPost(HttpServletRequest req, HttpServletResponse resp)}: metodo chiamato dal server per permettere all'oggetto servlet di acquisire una richiesta POST da parte di un client. Nel caso del progetto, il client è la logica applicativa dell'applicazione moviORDER e il server è ApacheTomcat.
\end{enumerate}

\textit{HttpServletRequest} è la classe Java che rappresenta le richieste HTTP che possono essere inviate all'oggetto servlet. Tramite opportuni metodi è possibile accedere alle informazioni contenute nella specifica richiesta. Nel caso del progetto, è stato utilizzato il metodo \textit{String getParameter(String name)} che, data una stringa rappresentante un parametro della richiesta HTTP, restituisce una stringa contente il valore associato a tale parametro oppure il valore \textit{null} se il parametro non esiste.

\textit{HttpServletResponse} è la classe Java che rappresenta la risposta dell'oggetto servlet alla richiesta del client. Tramite opportuni metodi è possibile configurare la risposta:
\begin{itemize}
	\item \textit{void setContentType(String type)}: metodo che permette di impostare la tipologia di contenuto della risposta. Poiché nel caso del progetto la risposta è una stringa in formato JSON, il content type impostato è di tipo \textit{application/json};
	\item \textit{PrintWriter getWriter()}: metodo che restituisce un oggetto \textit{PrintWriter} che può essere utilizzato per inviare caratteri di testo al client. Nel progetto, sul \textit{PrintWriter} restituito è stata scritta la stringa di risposta in formato JSON.
\end{itemize}

Viene di seguito fornita, a titolo d'esempio, l'implementazione del metodo \textit{doPost()} del servlet del servizio web che si occupa di controllare che le credenziali di autenticazione inserite dall'utente in fase di login siano corrette. Nella prossima sezione viene fornito un esempio di come la logica applicativa di moviORDER effettua una richiesta a tale servlet e di come utilizza la risposta per modificare lo stato dell'applicazione. Nell'esempio, la classe \textit{DatabaseConnection} fornisce un'interfaccia per l'interrogazione di un database SQL Server. Una spiegazione di tale classe è presente in sezione \ref{dbconnect}.
\begin{lstlisting}
protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String username = request.getParameter("username");
		String password = request.getParameter("password");
		DatabaseConnection dbConnect=new DatabaseConnection(GetParam.getUrlCommonDB());
		try {
			dbConnect.connectToDB();
		}catch(SQLException e) {
			e.printStackTrace();
		} 
		ResultSet rs=dbConnect.doQuery("select * from Users");
		String json ="";
		json = generateResponse(rs,username,password); //funzione che genera la stringa di risposta in formato JSON
		response.setContentType("application/json");
		response.getWriter().write(json);
		dbConnect.closeConnection();
		try {
			rs.close();
		}catch(SQLException e) {
			e.printStackTrace();
		}
	}
\end{lstlisting}


\subsubsection{Interrogazione del servizio web}

Nel momento in cui viene implementato un servlet concreto, eclipse gli associa un end-point in automatico. Tramite l'end-point è possibile raggiungere il servlet sul server per effettuare richieste HTTP. L'end-point associato da eclipse è della forma \textit{/NomeClasseServlet} e puo' essere cambiato dalle impostazioni dell'IDE. Per rendere possibile il raggiungimento del servizio web da parte della logica applicativa di moviORDER, è necessario che venga effettuato il deploy del servizio su Apache Tomcat e che quest'ultimo venga fatto girare sul server cloud di \visione{}. Una volta che il servizio web è raggiungibile tramite la rete, è possibile iniziare ad effettuare richieste HTTP. In moviORDER, la struttura dell'URL di una richiesta HTTP al servizio web è la seguente: \textit{http://indirizzo:porta/moviORDER/NomeServlet}, dove:
\begin{itemize}
	\item \textit{indirizzo}: è l'indirizzo del server dove il servizio web viene fatto girare:
	\item \textit{porta}: è la porta del server dove il servizio web viene fatto girare;
	\item \textit{NomeServlet}: è l'end-point del servlet a cui si vuole inviare la richiesta HTTP.
\end{itemize}

MoviORDER effettua richieste HTTP al servizio tramite l'utilizzo di AJAX (Asynchronous JavaScript And XML). È importante far notare che AJAX non è un linguaggio di programmazione, bensì una tecnica per accedere ad un server web da una pagina web. Tramite AJAX è possibile leggere dati da un server web dopo che una pagina è stata caricata, aggiornare una pagina web senza il bisogno di dover ricaricare la stessa e inviare dati ad un server web in maniera del tutto trasparente all'utente. 

Nel progetto, AJAX è stato implementato mediante JavaScript con l'utilizzo dell'oggetto \textit{XMLHttpRequest}. Tale oggetto è supportato da tutti i browser moderni e può essere utilizzato per scambiare dati con un server web in maniera trasparente, ovvero senza il bisogno di ricaricare la pagina web per effettuare delle modifiche alla stessa. La sintassi per creare un oggetto \textit{XMLHttpRequest} è la seguente:
\textit{var xhttp = new XMLHttpRequest();}. 

Per inviare richieste al servizio web si utilizzano i metodi \textit{open()} e \textit{send()} di tale oggetto. In particolare, il metodo \textit{open()} permette di specificare la tipologia di richiesta tramite il passaggio di tre parametri:
	\begin{itemize}
		\item \textbf{metodo}: parametro che specifica il metodo utilizzato per inviare la richiesta HTTP: GET o POST;
		\item \textbf{url}: parametro che specifica l'indirizzo del server a cui mandare la richiesta HTTP. Nel caso del progetto l'indirizzo comprende l'end-point del servlet che deve gestire la richiesta;
		\item \textbf{asincrona/sincrona}: parametro booleano che specifica se la richiesta è asincrona (true) o sincrona (false).
	\end{itemize}
Il metodo \textit{send(string)} permette invece di inviare la richiesta HTTP al servizio web, includendo una stringa contenente i parametri da inviare al server. Poiché alcuni parametri possono contenere caratteri accentati, è stato necessario utilizzare il metodo \textit{setRequestHeader()} per specificare la codifica dei caratteri, aggiungendo header HTTP alla richiesta. Facendo questo, è stato possibile evitare errori di lettura/scrittura di stringhe con caratteri accentati sul database di moviORDER. 

È importante far notare che tutte le richieste inviate da moviORDER al servizio web sono asincrone, questo perché:
\begin{itemize}
	\item il codice sincrono non è raccomandato perché JavaScript stopperebbe l'esecuzione del codice fino all'arrivo di una risposta da parte del server. Se il server è occupato o lento, l'applicazione potrebbe aspettare per un tempo prolungato;
	\item le richieste AJAX di tipo asincrono saranno rimosse dallo standard web nei prossimi anni. Scegliendo di utilizzare solamente richieste asincrone si permette a moviORDER di essere robusta a questo cambiamento futuro.
\end{itemize} 

Per la gestione della risposta ricevuta dal server si sono utilizzate le seguenti proprietà dell'oggetto \textit{XMLHttpRequest}:
\begin{itemize}
	\item \textit{readyState}: proprietà che contiene lo stato dell'oggetto. In particolare, nel contesto del progetto, è interessante sapere che il valore 4 corrisponde ad una richiesta la cui risposta è pronta;
	\item  \textit{status}: proprietà che contiene il messaggio sullo stato della richiesta. In particolare, nel contesto del progetto. è interessante sapere che il valore 200 corrisponde al messaggio OK, che nello standard rappresenta una richiesta HTTP andata a buon fine;
	\item \textit{onreadystatechange}: proprietà che definisce una funzione che deve essere eseguita quando la proprietà \textit{readyState} cambia valore;
	\item \textit{responseText}: proprietà che incapsula la stringa di risposta ricevuta dal servizio web. 
\end{itemize} 
Poiché la risposta ricevuta dal servizio web è una stringa in formato JSON, per effettuare il parsing di tale stringa è stato necessario convertirla in un oggetto JavaScript, tramite l'utilizzo del metodo \textit{JSON.parse()}.

Viene di seguito fornito, a titolo d'esempio, il codice JavaScript della logica applicativa di moviORDER che effettua una chiamata HTTP al servlet del servizio web che si occupa di gestire l'autenticazione. Il codice si occupa anche di gestire la risposta ricevuta dal servizio web. Tale funzione viene eseguita nel momento in cui l'utente di moviORDER preme sul pulsante di login presente nella schermata di login dell'applicazione.

\newpage

\begin{lstlisting}[tabsize=2]
function tryLogin(){
	var usern = document.getElementById("username").value;
	var password = document.getElementById("password").value;
	var xhttp = new XMLHttpRequest();
	if(usern!="" && password!=""){ //credenziali inserite
	  document.getElementById("loading").style.display = "block";
		xhttp.open("POST",host+"/moviORDER/AuthenticationServlet",true); //host e' l'indirizzo pubblico del server cloud di VisioneImpresa
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var risp=JSON.parse(this.responseText);
				if(risp.messaggio=="OK"){ //credenziali corrette
				    var xhttp1 = new XMLHttpRequest();
				    xhttp1.open("POST",host+"/moviORDER/CheckConnectionURL",true); //controllo di disponibilita' del server
				    xhttp1.onreadystatechange = function() {
				        if (xhttp1.readyState == 4 && xhttp1.status == 200) {
				            var risp2 = JSON.parse(xhttp1.responseText);
				            if(risp2.messaggio != "no"){ //server disponibile
				                document.getElementById("loading").style.display = "none";
				                location.replace("visualizzazioneArticoli.html?codAz="+risp.codAz+"&username="+risp.username);
				            }else{ //server non disponibile
				                document.getElementById("loading").style.display = "none";
				                navigator.notification.alert("Il database di Vision e' inconsistente per l'utente "+usern+".",null,"Errore");
				            }
				        }
				    };
				    xhttp1.setRequestHeader("Content-type", "application/x-www-form-urlencoded; charset=UTF-8");
                    xhttp1.send("codAz="+risp.codAz);
				}else{ //credenziali errate
				    document.getElementById("loading").style.display = "none";
					  showSomething(this); //visualizzazione errore identificato
				}
			}
		};
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded; charset=UTF-8");
		xhttp.send("username="+usern+"&password="+password);
	}else{ //credenziali non inserite
		var errore=document.getElementById("errorMessage");
		errore.innerHTML="Inserire username e password";
		errore.style.backgroundColor="#2196F3";
		errore.style.display="block";
	}
}
\end{lstlisting}

\subsubsection{API del servizio web}

In questa sezione viene presentata la API del servizio web di moviORDER. In particolare, per ogni end-point (servlet) vengono specificati:
\begin{itemize}
	\item input: costituito dai parametri inviati al servizio web tramite una richiesta HTTP;
	\item output: costituito da una stringa in formato JSON che presenta struttura diversa a seconda dell'end-point che gestisce la richiesta;
	\item descrizione.
\end{itemize}

\myparagraph{/AuthenticationServlet}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item username: è la username inserita dall'utente in fase di login;
			\item password: è la password inserita dall'utente in fase di login.
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item codice azienda e username dell'utente nel caso in cui username e password corrispondano ad un utente in database;
			\item un messaggio d'errore nel caso in cui username e password siano scorrette o l'utente è stato bloccato. 
		\end{itemize}
		\item \textbf{descrizione}: questo servlet rappresenta il servizio di autenticazione a moviORDER. Ricevuti i parametri, il servlet cerca la username dell'utente nel database e, nel caso questa fosse presente procede nel cercare la password corrispondente. Nel caso in cui username e password passati siano quelli corretti il servlet restituisce una stringa JSON contenente il codice azienda dell'utente che sta cercando di loggarsi e lo username dell'utente. Nel caso in cui la username o la password non siano corrette, oppure l'utente è stato bloccato, viene restituita una stringa JSON contenente un messaggio d'errore.
\end{itemize}

\myparagraph{/CheckConnectionURL}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item codice azienda: è il codice azienda dell'azienda cliente di \visione{} della quale si vuole verificare la presenza del database.
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item un messaggio positivo nel caso in cui il database dell'azienda corrispondente al codice inserito sia raggiungibile;
			\item un messaggio negativo nel caso in cui il database dell'azienda corrispondente al codice inserito non sia raggiungibile.
		\end{itemize}
	\item \textbf{descrizione}: questo servlet controlla se un database aziendale è raggiungibile effettuando una query su tale database. Risponde positivamente nel caso in cui il database dell'azienda corrispondente al codice inserito fosse raggiungibile (query con un ritorno), mentre risponde negativamente nel caso in cui il database non fosse raggiungibile (query che ha sollevato un eccezione).
\end{itemize}

\myparagraph{/DeleteSelectedItems}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item lista di codici articolo: è una lista di dei codici articolo degli articoli che devono essere eliminati;
			\item username: è la username dell'utente che ha richiesto l'eliminazione degli articoli;
			\item path: è la stringa di connessione al database aziendale dell'utente loggato.
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item un messaggio positivo nel caso in cui la cancellazione sia andata a buon fine;
			\item un messaggio negativo nel caso in cui la cancellazione non sia andata a buon fine.
		\end{itemize}
	\item \textbf{descrizione}: questo servlet si occupa di eliminare dal database aziendale dell'utente loggato gli articoli che l'utente ha richiesto di rimuovere dal carrello. Risponde positivamente nel caso in cui gli articoli sono stati rimossi correttamente dal database, mentre risponde negativamente nel caso in cui gli articoli non sono stati rimossi dal database.
\end{itemize}

\myparagraph{/FindArticleBarCode}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item codice a barre: è il codice a barre di un articolo del quale si vuole conoscere il codice articolo;
			\item path: è la stringa di connessione al database aziendale dell'utente loggato.
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item codice articolo corrispondente al barcode passato come parametro nel caso in cui il barcode corrisponda a quello di un articolo venduto dall'azienda;
			\item un messaggio negativo nel caso in cui il barcode passato come parametro non corrisponda ad un articolo venduto dall'azienda.
		\end{itemize}
	\item \textbf{descrizione}: questo servlet si occupa di fornire il codice articolo dell'articolo corrispondente al codice a barre ricevuto come parametro, effettuando la ricerca del barcode all'interno del database. Nel caso in cui il codice a barre sia presente all'interno del database viene restituito il codice articolo corrispondente, mentre nel caso in cui non fosse presente viene restituito un messaggio negativo.
\end{itemize}

\myparagraph{/FindArticleCode}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item codice articolo: è il codice articolo o il barcode di un articolo del quale si vuole verificare la presenza in database;
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item codice articolo nel caso in cui l'articolo sia presente in database;
			\item un messaggio negativo nel caso in cui l'articolo non sia presente in database.
		\end{itemize}
	\item \textbf{descrizione}: questo servlet si occupa di fornire il codice articolo dell'articolo corrispondente al codice articolo o al barcode ricevuto come parametro, effettuando la ricerca del codice articolo all'interno del database. Nel caso in cui il codice articolo o il barcode passato come parametro corrisponda ad un articolo presente in database viene restituito il codice articolo dell'articolo, mentre nel caso in cui non corrisponda ad un articolo presente in database viene restituito un messaggio negativo.
\end{itemize}

\myparagraph{/GetArticleDescNote}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item codice azienda: è il codice azienda della quale l'utente loggato è cliente;
			\item codice articolo: è il codice articolo dell'articolo del quale si vogliono ottenere informazioni.
		\end{itemize}
	\item \textbf{output}: questo servlet può produrre un solo output perché l'applicazione è stata implementata in modo che non ci siano casi negativi:
		\begin{itemize}
			\item descrizione, note, quantità minima ordinabile e step di quantità permessi per l'articolo corrispondente al codice articolo passato come parametro.
		\end{itemize}
	\item \textbf{descrizione}: questo servlet si occupa di fornire la descrizione, le note, la minima quantità ordinabile e lo step di quantità inseribile dell'articolo corrispondente al codice articolo passato come parametro. 
\end{itemize}

\myparagraph{/GetArticlesByUsername}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{descrizione}:
\end{itemize}

\myparagraph{/GetNameByUsername}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{descrizione}:
\end{itemize}

\myparagraph{/GetTmpArticleData}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{descrizione}:
\end{itemize}

\myparagraph{/InsertUpdateArticle}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{descrizione}:
\end{itemize}

\myparagraph{/SendOrder}

\begin{itemize}
	\item \textbf{input}:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{output}: le possibili risposte del servlet sono le seguenti:
		\begin{itemize}
			\item
		\end{itemize}
	\item \textbf{descrizione}:
\end{itemize}

\subsection{JDBC}

\subsubsection{Driver JDBC}

Un driver JDBC è una componente software che permette ad un'applicazione Java di interagire con un database. Per supportare la connessione a singoli database, JDBC (Java Database Connectivity API) richiede i driver per ogni database. Il driver permette la connessione con il database e implementa il protocollo di trasferimento di query e risultati tra il client e il database.

\subsubsection{Classe DataBaseConnection}

fare una lista di quali metodi dell'api sono stati utilizzati

\section{Logica applicativa}

Parlare dei plugin di phonegap e fare l'esempio del barcode scanner, parlare degli alert come permettono di essere convertiti in nativo e di tutte queste cose sui plugin. Aspetti negativi e positivi dei plugin nelle varie piattaforme, se funzionano allo stesso modo o ci sono state delle differenze sostanziali.

\section{Interfaccia grafica}

mostrare lo screen delle varie interfacce e spiegarne le interazioni utente
