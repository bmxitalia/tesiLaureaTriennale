\chapter{Codifica}

Questo capitolo tratta gli aspetti più interessanti della codifica dell'applicazione moviORDER. In particolare, il capitolo è stato diviso in sezioni che trattano la codifica di:
\begin{enumerate}
	\item servizio web;
	\item logica applicativa;
	\item interfaccia grafica.
\end{enumerate}

\section{Servizio web}

Per lo sviluppo del servizio web che permette all'applicazione di accedere al database presente sul server cloud di \visione{} si è utilizzato il linguaggio Java e, nello specifico, gli oggetti servlet. Per permettere agli oggetti servlet di interagire con il database si sono utilizzati i driver JDBC per Microsoft SQL Server. 

\subsection{Servlet}

\subsubsection{Struttura di un oggetto servlet}

Un oggetto servlet è implementato tramite una classe Java che eredita da \textit{HttpServlet}, appartenente al package \textit{javax.servlet.http}. \textit{HttpServlet} è una classe astratta che può essere estesa per creare un servlet HTTP utilizzabile per un sito web. Nel progetto realizzato, il servlet è stato utilizzato per acquisire richieste HTTP POST, elaborarle interrogando il database sul server cloud di \visione{}, e per rispondere ad esse tramite una stringa in formato JSON. Il metodo di \textit{HttpServlet} che è stato implementato da ogni servlet concreto è:
\begin{enumerate}
	\item \textit{protected void doPost(HttpServletRequest req, HttpServletResponse resp)}: metodo chiamato dal server per permettere all'oggetto servlet di acquisire una richiesta POST da parte di un client. Nel caso del progetto il client è la logica applicativa dell'applicazione moviORDER.
\end{enumerate}

\textit{HttpServletRequest} è la classe Java che rappresenta le richieste HTTP che arrivano all'oggetto servlet. Tramite opportuni metodi è possibile accedere alle informazioni contenute nella specifica richiesta. Nel caso del progetto, l'unico metodo utilizzato di \textit{HttpServletRequest} è stato \textit{String getParameter(String name)} che, data una stringa rappresentante un parametro della richiesta HTTP, restituisce una stringa contente il valore associato a tale parametro oppure il valore \textit{null} se il parametro non esiste.

\textit{HttpServletResponse} è la classe Java che rappresenta la risposta che l'oggetto servlet invia al client. Tramite opportuni metodi è possibile configurare la risposta. Nel caso del progetto sono stati utilizzati i seguenti metodi:
\begin{itemize}
	\item \textit{void setContentType(String type)}: metodo che permette di impostare la tipologia di contenuto della risposta che deve essere inviata al client. Poiché nel caso del progetto la risposta è una stringa in formato JSON, il content type impostato è \textit{application/json};
	\item \textit{PrintWriter getWriter()}: metodo che restituisce un oggetto \textit{PrintWriter} che può essere utilizzato per inviare caratteri di testo al client. Sul \textit{PrintWriter} restituito è stata scritta la risposta del servlet sottoforma di stringa in formato JSON.
\end{itemize}

Viene di seguito fornita, a titolo d'esempio, l'implementazione del metodo \textit{doPost()} del servlet del servizio web di moviORDER che si occupa di controllare che le credenziali di autenticazione inserite dall'utente in fase di login siano corrette. Nella prossima sezione viene fornito un esempio di come la logica applicativa di moviORDER effettua una richiesta a tale servlet e di come utilizza la risposta per interagire con l'utente. Nell'esempio, la classe \textit{DatabaseConnection} fornisce un'interfaccia per l'interrogazione di database. Una spiegazione di tale classe è presente in sezione \ref{dbconnect}.
\begin{lstlisting}
protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String username = request.getParameter("username");
		String password = request.getParameter("password");
		DatabaseConnection dbConnect=new DatabaseConnection(GetParam.getUrlCommonDB());
		try {
			dbConnect.connectToDB();
		}catch(SQLException e) {
			e.printStackTrace();
		} 
		ResultSet rs=dbConnect.doQuery("select * from Users");
		String json ="";
		json = generateResponse(rs,username,password); //funzione che genera la stringa di risposta in formato JSON
		response.setContentType("application/json");
		response.getWriter().write(json);
		dbConnect.closeConnection();
		try {
			rs.close();
		}catch(SQLException e) {
			e.printStackTrace();
		}
	}
\end{lstlisting}


\subsubsection{Interrogazione del servizio web}

Nel momento in cui si implementa un servlet concreto, eclipse gli associa un indirizzo in automatico. Tramite questo indirizzo è possibile raggiungere il servlet sul server per effettuare richieste HTTP. L'indirizzo associato da eclipse è della forma \textit{/NomeClasseServlet} e puo' essere cambiato dalle impostazioni dell'IDE. Per rendere possibile il raggiungimento del servizio web da parte della logica applicativa di moviORDER è necessario che venga effettuato il deploy del servizio su Apache Tomcat e che quest'ultimo venga fatto girare sul server cloud di \visione{}. Una volta che il servizio web è raggiungibile tramite la rete, è possibile iniziare ad effettuare richieste HTTP. In moviORDER, la struttura dell'URL di una richiesta HTTP al servizio web è la seguente: \textit{http://indirizzo:porta/moviORDER/NomeServlet}, dove:
\begin{itemize}
	\item \textit{indirizzo}: è l'indirizzo del server dove il servizio web viene fatto girare:
	\item \textit{porta}: è la porta del server dove il servizio web viene fatto girare;
	\item \textit{NomeServlet}: è il nome del servlet a cui si vuole mandare la richiesta HTTP.
\end{itemize}

MoviORDER effettua richieste HTTP al servizio tramite l'utilizzo di AJAX (Asynchronous JavaScript And XML) che permette l'invio e la ricezione asincrona di dati da un server. È importante far notare che AJAX non è un linguaggio di programmazione, bensì una tecnica per accedere ad un server web da una pagina web. Tramite AJAX è possibile leggere dati da un server web dopo che una pagina è stata caricata, aggiornare una pagina web senza il bisogno di dover ricaricare la stessa e inviare dati ad un server web in maniera del tutto trasparente all'utente. 

Nel progetto, AJAX è stato implementato mediante JavaScript con l'utilizzo dell'oggetto \textit{XMLHttpRequest}. Tale oggetto è supportato da tutti i browser moderni e può essere utilizzato per scambiare dati con un server web in maniera trasparente, ovvero senza il bisogno di ricaricare la pagina web per effettuare delle modifiche alla stessa. La sintassi per creare un oggetto \textit{XMLHttpRequest} è la seguente:
\textit{var xhttp = new XMLHttpRequest();}. 

Per inviare richieste al servizio web si utilizzano i metodi \textit{open()} e \textit{send()} dell'oggetto \textit{XMLHttpRequest()}. In particolare, il metodo \textit{open()} permette di specificare la tipologia di richiesta da effettuare tramite il passaggio di tre parametri:
	\begin{itemize}
		\item \textbf{metodo}: parametro che specifica il metodo utilizzato per inviare la richiesta HTTP: GET o POST;
		\item \textbf{url}: parametro che specifica l'indirizzo del server a cui mandare la richiesta HTTP. Nel caso del progetto l'indirizzo comprende l'indirizzo del servlet che deve gestire la richiesta;
		\item \textbf{asincrona/sincrona}: parametro booleano che specifica se la richiesta è asincrona (true) o sincrona (false).
	\end{itemize}
Il metodo \textit{send(string)} permette invece di inviare la richiesta HTTP al servizio web, includendo una stringa contenente i parametri da inviare al server. Poiché i valori dei parametri della richiesta possono contenere caratteri accentati, è stato necessario utilizzare il metodo \textit{setRequestHeader} per specificare la codifica dei caratteri, aggiungendo header HTTP alla richiesta. Facendo questo è stato possibile evitare errori di lettura/scrittura di stringhe con caratteri accentati sul database di moviORDER da parte del servizio web. È importante far notare che tutte le richieste inviate da moviORDER al servizio web sono asincrone, questo perché:
\begin{itemize}
	\item il codice sincrono non è raccomandato perché JavaScript stopperebbe l'esecuzione del codice fino all'arrivo di una risposta da parte del server. Se il server è occupato o lento, l'applicazione potrebbe aspettare per un tempo molto lungo;
	\item le richieste AJAX di tipo asincrono saranno rimosse dallo standard web nei prossimi anni. Scegliendo di utilizzare solamente richieste asincrone si permette a moviORDER di essere robusta a questo cambiamento futuro.
\end{itemize} 

Per la gestione della risposta ricevuta dal server si sono utilizzate le seguenti proprietà dell'oggetto \textit{XMLHttpRequest}:
\begin{itemize}
	\item \textit{readyState}: proprietà che contiene lo stato dell'oggetto. In particolare, nel contesto del progetto, è interessante sapere che il valore 4 corrisponde ad una richiesta terminata la cui risposta è pronta;
	\item  \textit{status}: proprietà che contiene il messaggio sullo stato della richiesta. In particolare, nel contesto del progetto. è interessante sapere che il valore 200 corrisponde al messaggio OK, che è la risposta standard di una richiesta HTTP andata a buon fine;
	\item \textit{onreadystatechange}: proprietà che definisce una funzione che deve essere eseguita quando la proprietà \textit{readyState} cambia valore;
	\item \textit{responseText}: proprietà che incapsula la stringa di risposta ricevuta dal servizio web. 
\end{itemize} 
Poiché la risposta ricevuta dal servizio web è una stringa in formato JSON, per effettuare il parsing di tale stringa è stato necessario convertirla in un oggetto JavaScript, tramite l'utilizzo del metodo \textit{JSON.parse()}.

Viene di seguito fornito, a titolo d'esempio, il codice JavaScript della logica applicativa di moviORDER che effettua una chiamata HTTP al servlet del servizio web che si occupa di gestire l'autenticazione. Il codice si occupa anche di gestire la risposta ricevuta dal servizio web. Tale funzione viene eseguita nel momento in cui l'utente di moviORDER preme sul pulsante di login presente nella schermata di login dell'applicazione.

\newpage

\begin{lstlisting}[tabsize=2]
function tryLogin(){
	var usern = document.getElementById("username").value;
	var password = document.getElementById("password").value;
	var xhttp = new XMLHttpRequest();
	if(usern!="" && password!=""){ //credenziali inserite
	  document.getElementById("loading").style.display = "block";
		xhttp.open("POST",host+"/moviORDER/AuthenticationServlet",true); //host e' l'indirizzo pubblico del server cloud di VisioneImpresa
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var risp=JSON.parse(this.responseText);
				if(risp.messaggio=="OK"){ //credenziali corrette
				    var xhttp1 = new XMLHttpRequest();
				    xhttp1.open("POST",host+"/moviORDER/CheckConnectionURL",true); //controllo di disponibilita' del server
				    xhttp1.onreadystatechange = function() {
				        if (xhttp1.readyState == 4 && xhttp1.status == 200) {
				            var risp2 = JSON.parse(xhttp1.responseText);
				            if(risp2.messaggio != "no"){ //server disponibile
				                document.getElementById("loading").style.display = "none";
				                location.replace("visualizzazioneArticoli.html?codAz="+risp.codAz+"&username="+risp.username);
				            }else{ //server non disponibile
				                document.getElementById("loading").style.display = "none";
				                navigator.notification.alert("Il database di Vision e' inconsistente per l'utente "+usern+".",null,"Errore");
				            }
				        }
				    };
				    xhttp1.setRequestHeader("Content-type", "application/x-www-form-urlencoded; charset=UTF-8");
                    xhttp1.send("codAz="+risp.codAz);
				}else{ //credenziali errate
				    document.getElementById("loading").style.display = "none";
					  showSomething(this); //visualizzazione errore identificato
				}
			}
		};
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded; charset=UTF-8");
		xhttp.send("username="+usern+"&password="+password);
	}else{ //credenziali non inserite
		var errore=document.getElementById("errorMessage");
		errore.innerHTML="Inserire username e password";
		errore.style.backgroundColor="#2196F3";
		errore.style.display="block";
	}
}
\end{lstlisting}



\subsubsection{API del servizio web}
fornire la lista di tutti gli indirizzi, dei parametri che richiedono e dell'output che ognuno può restituire

\subsection{JDBC}

\subsubsection{Driver JDBC}

Un driver JDBC è una componente software che permette ad un'applicazione Java di interagire con un database. Per supportare la connessione a singoli database, JDBC (Java Database Connectivity API) richiede i driver per ogni database. Il driver permette la connessione con il database e implementa il protocollo di trasferimento di query e risultati tra il client e il database.

\subsubsection{Classe DataBaseConnection}

fare una lista di quali metodi dell'api sono stati utilizzati

\section{Logica applicativa}

Parlare dei plugin di phonegap e fare l'esempio del barcode scanner, parlare degli alert come permettono di essere convertiti in nativo e di tutte queste cose sui plugin. Aspetti negativi e positivi dei plugin nelle varie piattaforme, se funzionano allo stesso modo o ci sono state delle differenze sostanziali.

\section{Interfaccia grafica}

mostrare lo screen delle varie interfacce e spiegarne le interazioni utente
